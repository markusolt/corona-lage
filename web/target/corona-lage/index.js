"use strict";const e={};e.box=(()=>{class e{constructor(e){this._val=void 0,this._ver_prev=0,this._ver=0,this._subs=[],this._subs_once=[],this.set(e)}get value(){return this._val}map(e){let n=t(void 0);return this.watch((t=>{n.set(e(t))})),n}set(e){this._ver+=1;let t=this._ver;n(e).then((e=>{this._ver_prev<t&&(this._ver_prev=t,Object.is(this._val,e)||(this._val=e,this.touch()))}))}then(e){if(void 0!==this._val)return n(e(this._val));{let t,n=new Promise((e=>{t=e}));return this._subs_once.push((n=>{t(e(n))})),n}}touch(){if(void 0!==this._val){for(let e of this._subs)e(this._val);for(let e of this._subs_once)e(this._val);this._subs_once.length=0}}until(e){void 0===this._val&&e()}watch(e){this._subs.push(e),void 0!==this._val&&e(this._val)}}function t(t){return new e(t)}function n(e){return null!=e&&"function"==typeof e.then?e:{then:t=>n(t(e))}}return t.all=function(e){let n=Array.from(e),r=n.map((e=>e.value)),a=t(r.includes(void 0)?void 0:r);return n.forEach(((e,t)=>{e.watch((e=>{r[t]=e,void 0!==e&&void 0!==a._val?a.touch():(a.set(void 0),r.includes(void 0)||a.set(r))}))})),a},t.any=function(e){let n=Array.from(e),r=n.map((e=>e.value)),a=t(r);return n.forEach(((e,t)=>{e.watch((e=>{r[t]=e,a.touch()}))})),a},t.thenable=n,t})(),e.csv=function*(e){let t=function*(e){let t=/(?<val>[^",\n]*("[^"]*"[^",\n]*)*)(?<del>,|\n+|$)/g,n=[];for(let r of e.matchAll(t)){let{val:e,del:t}=r.groups;if(n.push(e.trim().replace(/"/,"").replace(/"([^"]*)"?/g,((e,t)=>'""'===e?'"':t))),","!==t){if(""===t&&1===n.length&&""===n[0])return;yield n,n=[]}}}(e),n=t.next().value;for(let e of t)yield Object.fromEntries(n.map(((t,n)=>[t,e[n]])))},e.day=(()=>{class e{constructor(e){this._val=e}add(t){return new e(this._val+t)}since(e){return this._val-e._val}iso(){return new Date(864e5*this._val).toISOString().substr(0,10)}week_day(){return new Intl.DateTimeFormat(void 0,{weekday:"short"}).format(new Date(864e5*this._val))}}return function(t){return new e(Date.parse(t)/864e5)}})(),e.hay=(()=>{class e{constructor(){this._everything=new Set,this._map=new Map}insert(e,n){this._everything.add(n);for(let r of t(e))for(let e=0;e<r.length;e++){let t=r.substr(0,e+1);this._map.has(t)||this._map.set(t,new Set),this._map.get(t).add(n)}}find_sets(e){let n=t(e);return 0===n.length?[this._everything]:n.map((e=>this._map.get(e)||new Set))}find(e){return function(e){if(0===e.length)return[];let t=(e=e.filter(((e,t,n)=>n.indexOf(e)===t)).sort(((e,t)=>e.size-t.size))).slice(1);return Array.from(e[0]).filter((e=>t.every((t=>t.has(e)))))}(this.find_sets(e))}}function t(e){return e.toLowerCase().replace(/ä/g,"a").replace(/ö/g,"o").replace(/ü/g,"u").replace(/ß/g,"ss").split(/[^a-z0-9]+/g).filter(((e,t,n)=>e.length>2&&n.indexOf(e)===t))}return function(){return new e}})(),e.api=(()=>{const t=e.box,n=e.csv,r=e.day,a=e.hay;let i=null,o=null,s=t();class l{constructor(){}async update(){let e=(await u("/corona-lage/api/updated?r="+Math.floor(1e5*Math.random()))).trim();if(i===e)return!1;let t=c("/corona-lage/api/regions/regions.csv?v="+e.replace(/[^0-9]/g,"")),n=c("/corona-lage/api/cases/sum.csv?v="+e.replace(/[^0-9]/g,"")),l=await t,d=await n,h=new Map,p=a();for(let e of l){let{key:t,name:n,population:r,words:a}=e,i={key:t,name:n,population:Number(r)};h.set(t,i),p.insert(t,i),p.insert(n,i),p.insert(a,i)}for(let e of h.values())e.key.length>4&&p.insert(h.get(e.key.substring(0,4)).name,e);let m=r(e.substring(0,10)),f=new Array(500).fill(0).map(((e,t)=>{let n=m.add(-t);return{iso:n.iso(),rel:t,week_day:n.week_day()}})),g=[];for(let e of d){let t=f[m.since(r(e.date))],n=h.get(e.region),a=Number(e.cases),i=Number(e.cases_week_0),o=Number(e.cases_week_7),s=Math.pow(i/o,1/7),l=o/(Math.pow(s,0)+Math.pow(s,1)+Math.pow(s,2)+Math.pow(s,3)+Math.pow(s,4)+Math.pow(s,5)+Math.pow(s,6))*Math.pow(s,13)*7e5/n.population,u=l*(s-1),c=1e3*(Number(e.deaths_week_0)+Number(e.deaths_week_7))/(i+o),d={reg:n,date:t,cases:a,cases_rolling_avg:1e5*i/n.population,incidence:l,r:s,change:u,mortality:c};g.push(d)}return g.sort(((e,t)=>e.reg.key.localeCompare(t.reg.key)||Math.sign(e.date.rel-t.date.rel))),i=e,o={updated:e,asof:m,regions_map:h,regions_haystack:p,cases:g},s.touch(),!0}updated(){return new Date(o.updated)}data(){return o}}async function u(e){let t=await fetch(e);return t.ok?t.text():(console.error("Failed to load %o: %o",e,t),"")}async function c(e){return n(await u(e))}return(async()=>{let e=new l;await e.update()&&s.set(e)})(),s})(),e.spa=(()=>{let e=()=>!1,t=()=>{};function n(){t(e(window.location.href))}return sessionStorage.href&&(history.replaceState(null,"",sessionStorage.href),sessionStorage.href=""),window.addEventListener("click",(n=>{let r,a;!1===n.altKey&&!1===n.ctrlKey&&!1===n.metaKey&&!1===n.shiftKey&&Boolean(r=function(e){for(;e&&"A"!==e.tagName;)e=e.parentElement;return e}(n.target))&&Boolean(a=e(r.href))&&(n.preventDefault(),r.href!==window.location.href&&history.pushState(null,"",r.href),window.scrollTo(0,0),t(a))})),window.addEventListener("popstate",n),{install:function(r,a){e=r,t=a,n()},refresh:n}})(),e.leaf=(()=>{class e{constructor(e){this._node=e}append(e,n){return t(this._node,e,n),this}h1(e,n){return this.append(t(document.createElement("h1"),e),n)}h2(e,n){return this.append(t(document.createElement("h2"),e),n)}h3(e,n){return this.append(t(document.createElement("h3"),e),n)}p(e,n){return this.append(t(document.createElement("p"),e),n)}t(e,t){return this.append(document.createTextNode(e),t)}br(e){return this.append(document.createElement("br"),e)}i(e,n){return this.append(t(document.createElement("i"),e),n)}b(e,n){return this.append(t(document.createElement("b"),e),n)}a(e,n,r){let a=document.createElement("a");return a.href=n,t(a,e),this.append(a,r)}ul(e,n){let r=document.createElement("ul"),a=e&&e[Symbol.iterator]?e:[e];for(let e of a)r.appendChild(t(document.createElement("li"),e));return this.append(r,n)}}function t(t,n,r){let a=n instanceof Node?n:n instanceof e?n._node:document.createTextNode(n);return r&&r(a),t.appendChild(a),t}return function(t){return new e(t||document.createDocumentFragment())}})(),e.lorem=(()=>{const e=["ac","adipiscing","amet","ante","at","bibendum","blandit","consectetur","curabitur","cursus","dapibus","diam","dictum","dolor","donec","dui","eget","elementum","elit","enim","eros","et","eu","ex","fames","faucibus","finibus","fringilla","hendrerit","iaculis","imperdiet","in","interdum","ipsum","leo","lobortis","lorem","luctus","malesuada","mauris","metus","morbi","nec","neque","nisi","nisl","non","nulla","nunc","orci","phasellus","porttitor","posuere","primis","quisque","sapien","sem","semper","sit","sollicitudin","tempus","tincidunt","turpis","ut","vitae","viverra","vulputate"];return function(t){let n=e[Math.floor(Math.random()*e.length)];return n=n.substring(0,1).toUpperCase()+n.substring(1),n+new Array(t).fill(null).map((()=>e[Math.floor(Math.random()*e.length)])).join(" ")+"."}})(),e.main=(()=>{const t=e.api,n=e.spa,r=e.leaf;e.lorem;let a=[];t.then((e=>{window.api=e,a.forEach((t=>{t(e)}))}));{document.body.textContent="";let e=document.body.appendChild(document.createElement("main")),o=document.body.appendChild(document.createElement("footer")).appendChild(document.createElement("div"));o.classList.add("signature"),r(o).t("data: ").append(document.createElement("time"),(e=>{e.textContent="...",a.push((t=>{let n=t.updated();e.dateTime=n,e.textContent=n.toISOString().substring(0,19).replace("T"," ")}))})).br().t("website: ").append(document.createElement("time"),(e=>{let t=new Date("2021-02-23T16:45:41");e.dateTime=t,e.textContent=t.toISOString().substring(0,19).replace("T"," ")})).br().t("source: ").a("github.com","https://github.com/markusolt/corona-lage",(e=>{e.classList.add("subtle")})).br().t("author: ").a("markus","mailto:markus@blaumond.net",(e=>{e.classList.add("subtle")}));let s=location.origin+"/corona-lage";n.install((e=>{if(e.startsWith(s)){let t=e.substring(s.length);return{path:i(t,"?")[0].split("/").map((e=>decodeURIComponent(e).toLowerCase().replace(/^[^a-z]+|[^a-z0-9_\-]+|[^a-z0-9]+$/g,""))).filter((e=>e.length>0)),query:Object.fromEntries(i(i(t,"?")[1],"#")[0].split("&").map((e=>i(e,"="))).map((([e,t])=>[decodeURIComponent(e).toLowerCase().replace(/^[^a-z]+|[^a-z0-9_\-]+|[^a-z0-9]+$/g,""),decodeURIComponent(t).trim()||!0])).filter((([e,t])=>e.length>0)))}}return null}),(n=>{e.textContent="",r(e).append(function(e){let n="/"+e.path.join("/");if("/"===n)return r().h1("Welcome").p(r().t("Welcome to ").i("Corona Lage").t(". This is your daily update of Covid-19 incidence values across Germany. Go ahead and start ").a("here","/corona-lage/incidence").t(".")).ul([r().a("/cases","/corona-lage/cases"),r().a("/incidence","/corona-lage/incidence"),r().a("/cases-rolling-avg","/corona-lage/cases-rolling-avg")]);if("/cases"===n)return a({name:"Number of Positive Test Results",field:"cases",description:r().p("")});if("/cases-rolling-avg"===n)return a({name:"Cases - Rolling Average per Capita",field:"cases_rolling_avg",description:r().p(r().t("The average ").a("number of cases","/corona-lage/cases").t(" for the past 7 days per 100.000 people."))});if("/incidence"===n)return a({name:"Incidence",field:"incidence",description:r().p("")});return console.error("unknown resource: %o",{path:"/corona-lage/"+e.path.join("/")}),r();function a({name:e,field:n,description:a,precision:i}){let o=t.then((e=>e.data().cases.filter((e=>0===e.date.rel)).map((e=>({reg_key:e.reg.key,reg:e.reg.name,val:e[n]}))).sort(((e,t)=>t.val-e.val))));return r().h1(e).append(a).append(document.createElement("div"),(e=>{o.then((t=>{let n=t.find((e=>2===e.reg_key.length));r(e).t(n.reg+": ").b(n.val.toFixed(i))}))})).h3("Bundeslander").ul([],(e=>{o.then((t=>{for(let n of t)if(4===n.reg_key.length){let t=document.createElement("li");r(t).t(n.reg+": ").b(n.val.toFixed(i)),e.appendChild(t)}}))})).h3("Cities").ul([],(e=>{o.then((t=>{for(let n of t)if(7===n.reg_key.length){let t=document.createElement("li");r(t).t(n.reg+": ").b(n.val.toFixed(i)),e.appendChild(t)}}))}))}}(n)),0===e.childNodes.length&&r(e).h1("Status 404").p("There is nothing here, are you lost?").p(r().a("Go home","/corona-lage/").t("."))}))}function i(e,t){let n=(e.indexOf(t)+e.length+1)%(e.length+1);return[e.substring(0,n),e.substring(n+1)]}})();
